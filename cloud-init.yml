#cloud-config
# Headscale + Headplane VPS - Production Deployment
# Full documentation: https://github.com/anonhostpi/Headscale-VPS/blob/main/README.md

bootcmd:
  - |
    set -e
    REPO_URL="https://github.com/anonhostpi/Headscale-VPS"
    REPO_DIR="/tmp/headscale-vps-repo"

    echo "Downloading Headscale-VPS repository..."

    if command -v git >/dev/null 2>&1; then
      git clone --depth 1 "$REPO_URL" "$REPO_DIR"
    else
      mkdir -p "$REPO_DIR"
      curl -fsSL "${REPO_URL}/archive/refs/heads/main.tar.gz" | tar -xz -C "$REPO_DIR" --strip-components=1
    fi

    cd "$REPO_DIR"

    if [ ! -f write_files.yaml ]; then
      echo "ERROR: write_files.yaml not found"
      exit 1
    fi

    echo "Installing configuration files..."

    while IFS= read -r line; do
      if echo "$line" | grep -q "^  - path:"; then
        current_path=$(echo "$line" | sed 's/.*path: //' | tr -d '"')
      elif echo "$line" | grep -q "^    permissions:"; then
        current_perms=$(echo "$line" | sed 's/.*permissions: //' | tr -d '"')

        source_file="write_files${current_path}"

        if [ -f "$source_file" ]; then
          target_dir=$(dirname "$current_path")
          mkdir -p "$target_dir"
          cp "$source_file" "$current_path"
          chmod "$current_perms" "$current_path"
          echo "  ✓ $current_path ($current_perms)"
        else
          echo "  ✗ Not found: $source_file"
        fi
      fi
    done < write_files.yaml

    rm -rf "$REPO_DIR"
    echo "✓ Configuration files installed"

package_update: true
package_upgrade: false  # Disabled to prevent uncontrolled updates - use controlled update script instead

packages:
  # Core utilities
  - curl              # Used: NVM install, API health checks, GitHub API, Caddy GPG key
  - wget              # Used: Headscale .deb download with checksums
  - jq                # Used: JSON parsing (API keys, GitHub releases, health checks)
  - git               # Used: Clone Headplane repository
  - gettext-base      # Used: envsubst for template processing

  # Node.js dependencies (for Headplane)
  - libatomic1        # Used: Required by Node.js v25+ for atomic operations

  # Build tools (for Headplane dependencies)
  - build-essential   # Used: Compiler toolchain for native Node.js modules (better-sqlite3)

  # Go (for Headplane WASM build)
  - golang-go         # Used: Build hp_ssh.wasm from Headplane Go source

  # Security & monitoring
  - fail2ban          # Used: Intrusion prevention (SSH, OIDC, auth key jails)
  - ufw               # Used: Firewall management
  - auditd            # Used: Audit logging for config/secret access

  # TLS & certificates
  - ca-certificates   # Used: TLS certificate verification
  - gnupg             # Used: GPG key verification (Caddy repository)
  - openssl           # Used: Certificate operations in health checks

  # Email notifications
  - msmtp             # Used: SMTP email sending
  - msmtp-mta         # Used: sendmail compatibility for system emails

  # Automatic updates
  - unattended-upgrades  # Used: Automatic security updates
  - apt-listchanges      # Used: Email notifications for package changes

runcmd:
  - /opt/setup-headscale.sh
  - /opt/install-headplane.sh
