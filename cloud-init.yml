#cloud-config
# Headscale + Headplane VPS - Production Deployment
# Full documentation: https://github.com/anonhostpi/Headscale-VPS/blob/main/README.md

package_update: true
package_upgrade: false  # Disabled to prevent uncontrolled updates - use controlled update script instead

packages:
  # Core utilities
  - curl              # Used: NVM install, API health checks, GitHub API, Caddy GPG key
  - wget              # Used: Headscale .deb download with checksums
  - jq                # Used: JSON parsing (API keys, GitHub releases, health checks)
  - git               # Used: Clone Headplane repository
  - gettext-base      # Used: envsubst for template processing

  # Node.js dependencies (for Headplane)
  - libatomic1        # Used: Required by Node.js v25+ for atomic operations

  # Build tools (for Headplane dependencies)
  - build-essential   # Used: Compiler toolchain for native Node.js modules (better-sqlite3)

  # Go (for Headplane WASM build)
  - golang-go         # Used: Build hp_ssh.wasm from Headplane Go source

  # Security & monitoring
  - fail2ban          # Used: Intrusion prevention (SSH, OIDC, auth key jails)
  - ufw               # Used: Firewall management
  - auditd            # Used: Audit logging for config/secret access

  # TLS & certificates
  - ca-certificates   # Used: TLS certificate verification
  - gnupg             # Used: GPG key verification (Caddy repository)
  - openssl           # Used: Certificate operations in health checks

  # Email notifications
  - msmtp             # Used: SMTP email sending
  - msmtp-mta         # Used: sendmail compatibility for system emails

  # Automatic updates
  - unattended-upgrades  # Used: Automatic security updates
  - apt-listchanges      # Used: Email notifications for package changes

write_files:
  - path: /opt/write_files.yaml
    permissions: "0644"
    content: |
      # This file maps each installation file to its permissions.
      - path: /etc/headscale/versions.conf
        permissions: "0644"
      - path: /etc/headscale/constants.conf
        permissions: "0644"
      - path: /etc/apt/preferences.d/headscale-pinning
        permissions: "0644"
      - path: /usr/local/lib/headscale-common.sh
        permissions: "0644"
      - path: /usr/local/lib/headscale-validators.sh
        permissions: "0644"
      - path: /usr/local/lib/headscale-secrets.sh
        permissions: "0644"
      - path: /etc/ssh/sshd_config.d/99-hardening.conf
        permissions: "0644"
      - path: /etc/sysctl.d/99-security.conf
        permissions: "0644"
      - path: /usr/local/bin/headscale-config
        permissions: "0755"
      - path: /etc/headscale/templates/headscale.yaml.tpl
        permissions: "0644"
      - path: /etc/headscale/templates/headplane.yaml.tpl
        permissions: "0644"
      - path: /etc/headscale/templates/Caddyfile.tpl
        permissions: "0644"
      - path: /etc/systemd/system/headscale.service
        permissions: "0644"
      - path: /etc/systemd/system/headplane.service
        permissions: "0644"
      - path: /opt/install-headplane.sh
        permissions: "0755"
      - path: /usr/local/bin/headscale-rotate-apikey
        permissions: "0755"
      - path: /etc/cron.weekly/headscale-apikey-check
        permissions: "0755"
      - path: /usr/local/bin/headscale-migrate-secrets
        permissions: "0755"
      - path: /usr/local/bin/headscale-healthcheck
        permissions: "0755"
      - path: /etc/systemd/system/headscale-healthcheck.service
        permissions: "0644"
      - path: /etc/systemd/system/headscale-healthcheck.timer
        permissions: "0644"
      - path: /etc/logrotate.d/headscale
        permissions: "0644"
      - path: /etc/msmtprc
        permissions: "0600"
      - path: /usr/local/bin/msmtp-config
        permissions: "0755"
      - path: /etc/apt/apt.conf.d/50unattended-upgrades
        permissions: "0644"
      - path: /etc/apt/apt.conf.d/20auto-upgrades
        permissions: "0644"
      - path: /usr/local/bin/headscale-update
        permissions: "0755"
      - path: /etc/fail2ban/action.d/msmtp-mail.conf
        permissions: "0644"
      - path: /etc/fail2ban/jail.d/sshd.conf
        permissions: "0644"
      - path: /etc/fail2ban/filter.d/caddy-oidc.conf
        permissions: "0644"
      - path: /etc/fail2ban/jail.d/caddy-oidc.conf
        permissions: "0644"
      - path: /etc/fail2ban/filter.d/headscale-authkey.conf
        permissions: "0644"
      - path: /etc/fail2ban/jail.d/headscale.conf
        permissions: "0644"
      - path: /etc/fail2ban/jail.d/recidive.conf
        permissions: "0644"
      - path: /etc/audit/rules.d/headscale.rules
        permissions: "0644"
      - path: /opt/setup-headscale.sh
        permissions: "0755"

runcmd:
  - /opt/setup-headscale.sh
  - /opt/install-headplane.sh
