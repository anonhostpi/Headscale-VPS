#!/bin/bash
set -e

# Load shared libraries (headscale-secrets.sh loads constants.conf)
source /usr/local/lib/headscale-common.sh
source /usr/local/lib/headscale-validators.sh
source /usr/local/lib/headscale-secrets.sh

ENV_FILE="/etc/environment.d/headscale.conf"
TEMPLATES_DIR="/etc/headscale/templates"

# Load existing configuration if present
load_existing_config() {
  if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
  fi
}

# Prompt for a value with a default
prompt_value() {
  local var_name="$1"
  local prompt_text="$2"
  local default_value="$3"
  local is_secret="$4"
  
  local current_value="${!var_name:-$default_value}"
  
  if [ "$is_secret" = "true" ] && [ -n "$current_value" ] && [ "$current_value" != "$default_value" ]; then
    echo -n "$prompt_text [****hidden****]: "
  elif [ -n "$current_value" ]; then
    echo -n "$prompt_text [$current_value]: "
  else
    echo -n "$prompt_text: "
  fi
  
  if [ "$is_secret" = "true" ]; then
    read -s input_value
    echo ""
  else
    read input_value
  fi
  
  if [ -n "$input_value" ]; then
    printf -v "$var_name" '%s' "$input_value"
  elif [ -n "$current_value" ]; then
    printf -v "$var_name" '%s' "$current_value"
  fi
}

# Validate all inputs (using shared validation library)
validate_inputs() {
  local valid=true

  validate_domain "$HEADSCALE_DOMAIN" || { print_error "Invalid domain format: $HEADSCALE_DOMAIN"; valid=false; }
  validate_uuid "$AZURE_TENANT_ID" || { print_error "Invalid tenant ID format: $AZURE_TENANT_ID (expected GUID or *.onmicrosoft.com)"; valid=false; }
  validate_email "$ALLOWED_EMAIL" || { print_error "Invalid email format: $ALLOWED_EMAIL"; valid=false; }

  if [ -z "$AZURE_CLIENT_ID" ]; then
    print_error "Azure Client ID cannot be empty"
    valid=false
  fi

  if [ -z "$AZURE_CLIENT_SECRET" ]; then
    print_error "Azure Client Secret cannot be empty"
    valid=false
  fi

  if [ "$valid" = false ]; then
    return 1
  fi
  return 0
}

# Write environment file
write_env_file() {
  mkdir -p "$(dirname "$ENV_FILE")"
  cat > "$ENV_FILE" << EOF
# Headscale Configuration
# Generated by headscale-config on $(date)

HEADSCALE_DOMAIN="${HEADSCALE_DOMAIN}"
AZURE_TENANT_ID="${AZURE_TENANT_ID}"
AZURE_CLIENT_ID="${AZURE_CLIENT_ID}"
AZURE_CLIENT_SECRET="${AZURE_CLIENT_SECRET}"
ALLOWED_EMAIL="${ALLOWED_EMAIL}"
EOF
  chmod 600 "$ENV_FILE"
  print_success "Environment file written to $ENV_FILE"
}

# Write secret files
write_secrets() {
  local secret_file="/var/lib/headscale/oidc_client_secret"
  echo -n "${AZURE_CLIENT_SECRET}" > "$secret_file"
  chown headscale:headscale "$secret_file"
  chmod 600 "$secret_file"
  print_success "OIDC client secret written"

  # Encrypt the secret for systemd-creds
  encrypt_secret_if_supported "$secret_file" "oidc_client_secret"

  # Encrypt cookie_secret if it exists (generated during initial setup)
  if [ -f /var/lib/headplane/cookie_secret ]; then
    encrypt_secret_if_supported "/var/lib/headplane/cookie_secret" "cookie_secret"
  fi
}

# Generate Headscale API key for Headplane
generate_api_key() {
  if [ ! -f /var/lib/headscale/api_key ]; then
    echo "Generating Headscale API key for Headplane..."
    # Start headscale and wait for it to be ready
    systemctl start headscale
    
    # Wait for Headscale to be responsive
    local retries=${SERVICE_START_RETRY_COUNT}
    while [ $retries -gt 0 ]; do
      if headscale users list >/dev/null 2>&1; then
        break
      fi
      sleep ${SERVICE_START_RETRY_DELAY}
      retries=$((retries - 1))
    done

    if [ $retries -eq 0 ]; then
      print_error "Headscale failed to start within ${SERVICE_START_RETRY_COUNT} seconds"
      return 1
    fi
    
    local api_create_output api_create_error
    api_create_output=$(headscale apikeys create --expiration ${API_KEY_EXPIRATION_DAYS}d 2>&1)
    api_create_error=$?

    if [ $api_create_error -ne 0 ]; then
      print_error "Failed to create API key"
      echo "  Error details: $api_create_output" >&2
      return 1
    fi

    API_KEY=$(echo "$api_create_output" | tail -1)
    if [ -z "$API_KEY" ]; then
      print_error "API key creation returned empty result"
      return 1
    fi

    local api_key_file="/var/lib/headscale/api_key"
    echo -n "$API_KEY" > "$api_key_file"
    chown headscale:headscale "$api_key_file"
    chmod 600 "$api_key_file"
    # Record expiration date for rotation tracking
    date -d "+${API_KEY_EXPIRATION_DAYS} days" +%Y-%m-%d > /var/lib/headscale/api_key_expires
    chown headscale:headscale /var/lib/headscale/api_key_expires
    chmod 600 /var/lib/headscale/api_key_expires
    print_success "Headscale API key generated (expires in ${API_KEY_EXPIRATION_DAYS} days)"

    # Encrypt the API key for systemd-creds
    encrypt_secret_if_supported "$api_key_file" "headscale_api_key"
  else
    print_success "Headscale API key already exists"
    # Check if key is expiring soon
    if [ -f /var/lib/headscale/api_key_expires ]; then
      local expires=$(cat /var/lib/headscale/api_key_expires)
      local today=$(date +%Y-%m-%d)
      local days_left=$(( ($(date -d "$expires" +%s) - $(date -d "$today" +%s)) / 86400 ))
      if [ $days_left -lt ${API_KEY_WARNING_THRESHOLD_DAYS} ]; then
        print_warning "API key expires in $days_left days - run 'sudo headscale-rotate-apikey' to renew"
      fi
    fi
  fi
}

# Process templates with envsubst
process_templates() {
  echo ""
  echo "Processing configuration templates..."
  
  # Verify all templates exist
  local templates=("headscale.yaml.tpl" "headplane.yaml.tpl" "Caddyfile.tpl")
  for tpl in "${templates[@]}"; do
    if [ ! -f "$TEMPLATES_DIR/$tpl" ]; then
      print_error "Template file missing: $TEMPLATES_DIR/$tpl"
      exit 1
    fi
  done
  
  # Export variables for envsubst
  export HEADSCALE_DOMAIN
  export AZURE_TENANT_ID
  export AZURE_CLIENT_ID
  export AZURE_CLIENT_SECRET
  export ALLOWED_EMAIL

  # Process each template
  envsubst '${HEADSCALE_DOMAIN} ${AZURE_TENANT_ID} ${AZURE_CLIENT_ID} ${ALLOWED_EMAIL}' \
    < "$TEMPLATES_DIR/headscale.yaml.tpl" \
    > /etc/headscale/config.yaml
  chown headscale:headscale /etc/headscale/config.yaml
  chmod 640 /etc/headscale/config.yaml
  print_success "Headscale config generated"

  envsubst '${HEADSCALE_DOMAIN} ${AZURE_TENANT_ID} ${AZURE_CLIENT_ID}' \
    < "$TEMPLATES_DIR/headplane.yaml.tpl" \
    > /etc/headplane/config.yaml
  chown headscale:headscale /etc/headplane/config.yaml
  chmod 640 /etc/headplane/config.yaml
  print_success "Headplane config generated"
  
  envsubst '${HEADSCALE_DOMAIN}' \
    < "$TEMPLATES_DIR/Caddyfile.tpl" \
    > /etc/caddy/Caddyfile
  chmod 644 /etc/caddy/Caddyfile
  print_success "Caddyfile generated"
}

# Restart services
restart_services() {
  echo ""
  echo "Restarting services..."
  
  systemctl restart headscale && print_success "Headscale restarted" || print_error "Headscale failed to restart"
  sleep 2
  
  # Generate API key after headscale is running
  generate_api_key
  
  if [ -f /opt/headplane/build/server/index.js ]; then
    systemctl restart headplane && print_success "Headplane restarted" || print_error "Headplane failed to restart"
  else
    print_error "Headplane not running - check logs: journalctl -u headplane -n 50"
  fi
  
  systemctl restart caddy && print_success "Caddy restarted" || print_error "Caddy failed to restart"
}

# Show status
show_status() {
  echo ""
  echo "=========================================="
  echo "  Service Status"
  echo "=========================================="
  echo ""
  
  systemctl is-active headscale >/dev/null 2>&1 && print_success "Headscale is running" || print_error "Headscale is not running"
  systemctl is-active caddy >/dev/null 2>&1 && print_success "Caddy is running" || print_error "Caddy is not running"
  systemctl is-active fail2ban >/dev/null 2>&1 && print_success "Fail2ban is running" || print_error "Fail2ban is not running"
  
  if [ -f /opt/headplane/build/server/index.js ]; then
    systemctl is-active headplane >/dev/null 2>&1 && print_success "Headplane is running" || print_error "Headplane is not running"
  fi
  
  echo ""
  echo "=========================================="
  echo "  Endpoints"
  echo "=========================================="
  echo ""
  echo "  Headplane UI:  https://${HEADSCALE_DOMAIN}/admin"
  echo "  Headscale API: https://${HEADSCALE_DOMAIN}/api"
  echo ""
  echo "=========================================="
  echo "  Client Connection"
  echo "=========================================="
  echo ""
  echo "  tailscale up --login-server https://${HEADSCALE_DOMAIN}"
  echo ""
}

# Main configuration flow
main() {
  print_banner "Headscale + Headplane Configuration"
  load_existing_config

  # Skip prompts if all required variables are already set (for automated deployment)
  if [ -n "$HEADSCALE_DOMAIN" ] && [ -n "$AZURE_TENANT_ID" ] && [ -n "$AZURE_CLIENT_ID" ] && [ -n "$AZURE_CLIENT_SECRET" ] && [ -n "$ALLOWED_EMAIL" ]; then
    echo "Using provided configuration values..."
  else
    echo "For Azure AD setup instructions, see:"
    echo "  https://github.com/anonhostpi/Headscale-VPS/blob/main/AZURE_AD_SETUP.md"
    echo ""

    prompt_value "HEADSCALE_DOMAIN" "Domain (e.g., vpn.example.com)" ""
    prompt_value "AZURE_TENANT_ID" "Azure Tenant ID (e.g., xxx.onmicrosoft.com or GUID)" ""
    prompt_value "AZURE_CLIENT_ID" "Azure Application (Client) ID" ""
    prompt_value "AZURE_CLIENT_SECRET" "Azure Client Secret Value" "" "true"
    prompt_value "ALLOWED_EMAIL" "Allowed Email Address (for login)" ""
  fi
  
  echo ""
  echo "Configuration Summary:"
  echo "  Domain:        ${HEADSCALE_DOMAIN}"
  echo "  Tenant ID:     ${AZURE_TENANT_ID}"
  echo "  Client ID:     ${AZURE_CLIENT_ID}"
  echo "  Client Secret: ****"
  echo "  Allowed Email: ${ALLOWED_EMAIL}"
  echo ""

  # Validate inputs before proceeding
  if ! validate_inputs; then
    print_error "Please fix the validation errors above and try again."
    exit 1
  fi

  # Skip confirmation if all env vars are set (automated deployment)
  if [ -n "$HEADSCALE_DOMAIN" ] && [ -n "$AZURE_TENANT_ID" ] && [ -n "$AZURE_CLIENT_ID" ] && [ -n "$AZURE_CLIENT_SECRET" ] && [ -n "$ALLOWED_EMAIL" ]; then
    echo "Applying configuration automatically..."
    write_env_file
    write_secrets
    process_templates
    restart_services
    show_status
  else
    read -p "Apply this configuration? [y/N] " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      write_env_file
      write_secrets
      process_templates
      restart_services
      show_status
    else
      echo "Configuration cancelled."
      exit 1
    fi
  fi
}

# Run main
main "$@"