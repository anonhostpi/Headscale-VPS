#!/bin/bash
set -e

# Load shared libraries
source /usr/local/lib/headscale-common.sh
source /usr/local/lib/headscale-secrets.sh

CREDSTORE="/etc/credstore.encrypted"
OIDC_SECRET_PLAIN="/var/lib/headscale/oidc_client_secret"
API_KEY_PLAIN="/var/lib/headscale/api_key"
SMTP_PASSWORD_PLAIN="/etc/msmtp-password"

print_banner "Headscale Secrets Migration"

# Check systemd-creds support
if ! check_systemd_creds_support; then
  SYSTEMD_VERSION=$(get_systemd_version)
  print_error "systemd-creds not supported (version $SYSTEMD_VERSION < 250)"
  print_info "Keeping plaintext secrets with 600 permissions"
  exit 1
fi

# Create credstore directory
mkdir -p "$CREDSTORE"
chmod 700 "$CREDSTORE"

# Function to encrypt a secret using systemd-creds
# Wrapper around shared function for this script
encrypt_secret() {
  local plain_file="$1"
  local cred_name="$2"

  if [ ! -f "$plain_file" ]; then
    print_warning "Plaintext secret not found: $plain_file (skipping)"
    return 0
  fi

  if [ ! -s "$plain_file" ]; then
    print_warning "Plaintext secret is empty: $plain_file (skipping)"
    return 0
  fi

  print_info "Encrypting $cred_name..."

  # Use shared encryption function
  if encrypt_secret_if_supported "$plain_file" "$cred_name"; then
    # Backup plaintext (for rollback)
    cp "$plain_file" "${plain_file}.plaintext-backup"
    chmod 600 "${plain_file}.plaintext-backup"
    print_info "Plaintext backup: ${plain_file}.plaintext-backup"
    return 0
  else
    print_error "Failed to encrypt $cred_name"
    return 1
  fi
}

# Function to rollback to plaintext
rollback_secret() {
  local plain_file="$1"
  local cred_name="$2"
  local encrypted_file="$CREDSTORE/${cred_name}.cred"
  local backup_file="${plain_file}.plaintext-backup"

  if [ -f "$encrypted_file" ]; then
    rm -f "$encrypted_file"
    print_info "Removed encrypted credential: $cred_name"
  fi

  if [ -f "$backup_file" ]; then
    mv "$backup_file" "$plain_file"
    print_success "Restored plaintext from backup: $plain_file"
  fi
}

# Main migration logic
case "${1:-migrate}" in
  migrate)
    print_info "Migrating secrets to systemd-creds encryption..."
    echo ""

    # Migrate OIDC client secret
    if encrypt_secret "$OIDC_SECRET_PLAIN" "oidc_client_secret"; then
      print_success "OIDC secret migration complete"
    else
      print_error "OIDC secret migration failed"
    fi

    # Migrate API key
    if encrypt_secret "$API_KEY_PLAIN" "headscale_api_key"; then
      print_success "API key migration complete"
    else
      print_error "API key migration failed"
    fi

    # Migrate SMTP password
    if encrypt_secret "$SMTP_PASSWORD_PLAIN" "smtp_password"; then
      print_success "SMTP password migration complete"
    else
      print_error "SMTP password migration failed"
    fi

    echo ""
    print_info "Migration summary:"
    ls -lh "$CREDSTORE/" 2>/dev/null || print_warning "No credentials encrypted"
    echo ""
    print_warning "To apply changes, update service files and restart services:"
    print_info "  systemctl daemon-reload"
    print_info "  systemctl restart headscale headplane"
    ;;

  rollback)
    print_warning "Rolling back to plaintext secrets..."
    echo ""

    rollback_secret "$OIDC_SECRET_PLAIN" "oidc_client_secret"
    rollback_secret "$API_KEY_PLAIN" "headscale_api_key"
    rollback_secret "$SMTP_PASSWORD_PLAIN" "smtp_password"

    echo ""
    print_success "Rollback complete - using plaintext secrets"
    ;;

  status)
    print_info "Secrets encryption status:"
    echo ""

    for secret in oidc_client_secret headscale_api_key smtp_password; do
      if [ -f "$CREDSTORE/${secret}.cred" ]; then
        print_success "$secret: encrypted"
      else
        print_warning "$secret: plaintext"
      fi
    done
    ;;

  *)
    echo "Usage: $0 {migrate|rollback|status}"
    echo ""
    echo "Commands:"
    echo "  migrate   - Encrypt plaintext secrets using systemd-creds"
    echo "  rollback  - Restore plaintext secrets from backups"
    echo "  status    - Show encryption status of secrets"
    exit 1
    ;;
esac